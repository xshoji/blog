<!doctype html><html lang=ja dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>Go 標準の flag パッケージのテクニック集その2: ロングオプションへ対応する | xshoji's blog</title><link rel=icon type=image/x-icon href=/favicon.ico><link rel=stylesheet href=/css/main.min.e7b27d5cc721009cd16d53f6bf32763b3aafdc9b8c1f4758578b2334061811e1.css integrity="sha256-57J9XMchAJzRbVP2vzJ2Ozqv3JuMH0dYV4sjNAYYEeE=" crossorigin=anonymous><script src=/js/main.9bb57b255d451daab90a38635d9a16e73e51de496c83fe4ca2590051d38d11f8.js integrity="sha256-m7V7JV1FHaq5CjhjXZoW5z5R3klsg/5MolkAUdONEfg=" crossorigin=anonymous defer></script><script src=/js/lightbox.bc1534d02ae012fc45a8e5abd1956570e73c4619dd2d3aa46703a03833c1f068.js integrity="sha256-vBU00CrgEvxFqOWr0ZVlcOc8RhndLTqkZwOgODPB8Gg=" crossorigin=anonymous defer></script></head><body><header class="w-full p-md border-b border-border bg-surface sticky top-0 z-50 backdrop-blur bg-surface-alpha transition will-change-transform"><div class="max-w-max mx-auto flex justify-between items-center transition"><h1 class="blog-name text-lg font-sans font-semibold tracking-tight m-0 transition transform-origin-left"><a href=/ class="text-primary border-b border-transparent hover:text-accent transition">xshoji's blog</a></h1><nav class="blog-menu m-0 transition-fast"><ul class="list-none flex gap-md md:gap-lg items-center"><li class="mb-0 leading-relaxed"><a class="nav-link text-sm font-medium tracking-sm uppercase text-secondary border-none py-xs pb-xs relative" href=/posts/>Blog</a></li><li class="mb-0 leading-relaxed"><a class="nav-link text-sm font-medium tracking-sm uppercase text-secondary border-none py-xs pb-xs relative" href=/about/>About</a></li><li class="mb-0 leading-relaxed"><a class="nav-link text-sm font-medium tracking-sm uppercase text-secondary border-none py-xs pb-xs relative" href=/tags/>Tags</a></li></ul></nav></div></header><main><article class="max-w-content mx-auto"><header class=mb-xl><div class="post-meta flex flex-wrap gap-xs items-center text-xs text-tertiary uppercase tracking-wider font-semibold mb-md"><time class=text-accent datetime=2026-01-12T02:33:24+09:00>2026-01-12
</time><span class="w-5 h-1px bg-border"></span>
<span class="ml-auto text-right whitespace-nowrap">9 min read</span></div><h1 class="post-title text-2xl font-sans font-semibold leading-snug mt-xs mb-xs"><a href=https://blog.xshoji.com/posts/20260112_golang-flag-pretty-usage-with-long/ class="text-primary border-b border-transparent hover:text-accent">Go 標準の flag パッケージのテクニック集その2: ロングオプションへ対応する</a></h1><div class="flex gap-xs flex-wrap"><a href=/tags/golang/ class="text-xs px-08 py-03 bg-accent-light text-accent rounded-sm font-medium tracking-sm border-transparent transition-fast hover:bg-accent hover:text-surface hover:border-accent hover:translate-y--1">#golang</a>
<a href=/tags/go/ class="text-xs px-08 py-03 bg-accent-light text-accent rounded-sm font-medium tracking-sm border-transparent transition-fast hover:bg-accent hover:text-surface hover:border-accent hover:translate-y--1">#go</a>
<a href=/tags/flag/ class="text-xs px-08 py-03 bg-accent-light text-accent rounded-sm font-medium tracking-sm border-transparent transition-fast hover:bg-accent hover:text-surface hover:border-accent hover:translate-y--1">#flag</a>
<a href=/tags/cli/ class="text-xs px-08 py-03 bg-accent-light text-accent rounded-sm font-medium tracking-sm border-transparent transition-fast hover:bg-accent hover:text-surface hover:border-accent hover:translate-y--1">#cli</a>
<a href=/tags/command-line/ class="text-xs px-08 py-03 bg-accent-light text-accent rounded-sm font-medium tracking-sm border-transparent transition-fast hover:bg-accent hover:text-surface hover:border-accent hover:translate-y--1">#command-line</a>
<a href=/tags/usage/ class="text-xs px-08 py-03 bg-accent-light text-accent rounded-sm font-medium tracking-sm border-transparent transition-fast hover:bg-accent hover:text-surface hover:border-accent hover:translate-y--1">#usage</a></div></header><details id=TableOfContents aria-label=目次><summary><h3 class="text-sm font-semibold mt-0 mb-sm opacity-75">目次</h3></summary><nav id=TableOfContents><ul><li><a href=#そもそもの問題点>そもそもの問題点</a></li><li><a href=#ロングオプションの利点>ロングオプションの利点</a></li><li><a href=#今回作ったもの>今回作ったもの</a></li><li><a href=#スニペットの紹介>スニペットの紹介</a></li><li><a href=#実装の解説>実装の解説</a><ul><li><a href=#defineflagvalue>defineFlagValue</a></li><li><a href=#customusage>customUsage</a></li><li><a href=#getoptionsusage>getOptionsUsage</a></li></ul></li><li><a href=#まとめ>まとめ</a></li></ul></nav></details><div class="article-content text-base leading-relaxed text-secondary"><p><a href=https://blog.xshoji.com/posts/20260103_golang-flag-pretty-usage/>Go 標準の flag パッケージのテクニック集その1: Usageを綺麗に整形して見やすくする | xshoji&rsquo;s blog</a></p><p>の続きです。前回は、Go 標準の flag パッケージで Usage を綺麗に整形する方法を紹介しました。
Usage は見やすくなったのですが、次の要件として、ロングオプションを扱いたい、というのがあります。</p><p>Unix系のコマンドラインツールでは、一般的にショートオプション（ <code>-f</code> のような1文字のオプション）とロングオプション（ <code>--file</code> のような複数文字のオプション）の両方をサポートしていることが多いです。
Go 標準の flag パッケージは、 任意の文字列をフラグ名として定義できるので、ショートオプションとロングオプションの両方を実装上定義することは可能ですが、それらが同じ意味のオプションであることが Usage からは伝わりづらいので、そのままではとても使えません。</p><p>前回紹介した有名な <a href=https://github.com/spf13/cobra>spf13/cobra</a> や <a href=https://github.com/urfave/cli>urfave/cli</a> といったフレームワークを使えば簡単に実現できるのですが、
今回はあえて main.go のみで実装することにこだわりたかったため、Go 標準の flag パッケージだけでロングオプションを扱えるようにする方法を試行錯誤してみました。</p><p>多少複雑ですが、実用的な実装ができたので、今回はその実装方法について紹介したいと思います。</p><blockquote><p>注意: この記事で紹介するスニペットは Go 1.18以上（Genericsを使用するため） が必要です</p></blockquote><h2 id=そもそもの問題点>そもそもの問題点</h2><p>通常、Go 標準の flag パッケージを使ってコマンドライン引数を定義する場合、以下のようにします。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>filePath</span> = <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;f&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;Path to the file&#34;</span>)
</span></span></code></pre></div><p>この場合、 <code>-f</code> オプションでファイルパスを指定できるようになります。
しかし、これだけではロングオプション（ <code>--file</code> ）をサポートすることはできません。
これに対して、 flag パッケージは、以下のように複数の名前で同じ変数を定義することができます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>filePath</span> = <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;f&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;Path to the file&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>StringVar</span>(<span style=color:#a6e22e>filePath</span>, <span style=color:#e6db74>&#34;file&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;Path to the file&#34;</span>)
</span></span></code></pre></div><p>このようにすると、 <code>-f</code> と <code>--file</code> の両方で同じ変数に値を設定できるようになります。
しかし、これだけでは Usage 出力時に両方のオプションが別々に表示されてしまい、同じ意味のオプションであることが伝わりづらいです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>Usage of ./myapp:
</span></span><span style=display:flex><span>  -f string
</span></span><span style=display:flex><span>        Path to the file
</span></span><span style=display:flex><span>  -file string
</span></span><span style=display:flex><span>        Path to the file
</span></span></code></pre></div><p>まぁ、これはオプションが1つなのでまだ良いんですが、複数オプションになるとかなり見づらくなります。
前回紹介した、 Custom Usage での表示を踏襲し、以下のように表示できると理想的だと思います。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>Usage: myapp [options]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Options:
</span></span><span style=display:flex><span>  -f, --file string        Path to the file
</span></span></code></pre></div><h2 id=ロングオプションの利点>ロングオプションの利点</h2><p>次に、そもそもロングオプションをサポートする必要ってあるの？ という点について私の考えをまとめておきます。
ロングオプションをサポートすると、シンプルに「オプション名が直感的に分かりやすい」という利点が生まれます。</p><p>例: <code>-f</code> よりも <code>--file-path</code> の方がオプションの意味が直感的</p><p>この結果、業務でコマンドラインツールを使う際に以下のようなメリットがあります。</p><ul><li>実行結果の証跡をあとから見たときに、オプションの意味が分かりやすい</li><li>オプションの値を変えて実行する際に help を見なくても意味を推測しやすくなる</li><li>(最近だと) AIに実行させる場合にオプションの意味が伝わりやすい&mldr;かもしれません</li></ul><p>ということで、もし手間でなければなるべくロングオプションもサポートしておくと良いのかな、と思っています。</p><h2 id=今回作ったもの>今回作ったもの</h2><p>前回の記事で紹介した Custom Usage を基に、ロングオプションのサポートを追加したよりリッチなスニペットを考えました。
今回紹介するスニペットを使うと、以下のように main.go のみでも良い感じにロングオプションをサポートできるようになります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>[01-12 02:53:17] macbookpro sample$ ls -al
</span></span><span style=display:flex><span>total 8
</span></span><span style=display:flex><span>drwxr-xr-x   3 user  wheel    96 Jan 12 02:53 .
</span></span><span style=display:flex><span>drwxrwxrwt  15 root  wheel   480 Jan 12 02:53 ..
</span></span><span style=display:flex><span>-rw-r--r--   1 user  wheel  3872 Jan 12 02:50 main.go
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[01-12 02:53:18] macbookpro sample$ go run main.go -h
</span></span><span style=display:flex><span>Usage: main --file-path &lt;string&gt; [OPTIONS]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Description:
</span></span><span style=display:flex><span>  A sample command demonstrating full template usage in Go CLI applications.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Options:
</span></span><span style=display:flex><span>  -f, --file-path &lt;string&gt;          (required) File path
</span></span><span style=display:flex><span>  -d, --debug                       Debug mode
</span></span><span style=display:flex><span>  -l, --line-index &lt;int&gt;            Index of line (default 10)
</span></span><span style=display:flex><span>  -u, --url &lt;string&gt;                URL (default https://httpbin.org/get)
</span></span><span style=display:flex><span>  -w, --wait-seconds &lt;duration&gt;     Duration of wait seconds (e.g., 500ms, 3s, 2m) (default 1s)
</span></span></code></pre></div><p>依存なしの main.go のみで実装してる割には、かなり本格的なCLIっぽいUsage表示ができているのでは、と思います。
前回紹介した Custom Usage で工夫した以下の点</p><ul><li>正確な実行バイナリ名を表示する</li><li>コマンドの説明文の表示</li><li>オプション一覧が一行で表示される</li><li>必須のオプションがどれか分かりやすい（上位に表示される）</li></ul><p>は当然踏襲していて、それに加えてロングオプションもサポートできています。
また、細かい点ですが、1行目の Usage 表示で、必須オプションの指定が例示されるようになっていて、よりユーザーフレンドリーな Usage を表示できるようになっています。
その他の工夫として、ロングオプションが加わるとオプション列の横幅が動的に変わるため、
Usage 出力時にオプション名の横幅を自動調整するような実装も入れていて、ロングオプション名が長くなっても綺麗に整列して表示されます。</p><h2 id=スニペットの紹介>スニペットの紹介</h2><p>では、今回作成したスニペットを紹介します。
使う際は、このスニペットをコピペして</p><ul><li><code>commandDescription</code> を自分のツールの説明に置き換える</li><li><code>optionXxxx</code> 等のオプション定義部分を自分のツールのオプションに置き換える</li><li><code>func main()</code> にメインの処理を実装する</li></ul><p>を修正してもらえればOKです。
<code>flag Utils</code> より下のコードは、Usage のフォーマットをカスタマイズしたい場合以外はそのままコピペで問題ありません。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span> <span style=color:#e6db74>&#34;embed&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;flag&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;path/filepath&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;sort&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;strconv&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;strings&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Req</span>        = <span style=color:#e6db74>&#34;(required)&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>UsageDummy</span> = <span style=color:#e6db74>&#34;########&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>commandDescription</span> = <span style=color:#e6db74>&#34;A sample command demonstrating full template usage in Go CLI applications.&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Command options (the -h and --help flags are provided by default in the flag package)</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>optionFilePath</span>        = <span style=color:#a6e22e>defineFlagValue</span>(<span style=color:#e6db74>&#34;f&#34;</span>, <span style=color:#e6db74>&#34;file-path&#34;</span> <span style=color:#75715e>/*    */</span>, <span style=color:#a6e22e>Req</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#34; File path&#34;</span> <span style=color:#75715e>/*                                 */</span>, <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#75715e>/*                         */</span>, <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>String</span>, <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>StringVar</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>optionUrl</span>             = <span style=color:#a6e22e>defineFlagValue</span>(<span style=color:#e6db74>&#34;u&#34;</span>, <span style=color:#e6db74>&#34;url&#34;</span> <span style=color:#75715e>/*          */</span>, <span style=color:#e6db74>&#34;URL&#34;</span> <span style=color:#75715e>/*                                            */</span>, <span style=color:#e6db74>&#34;https://httpbin.org/get&#34;</span> <span style=color:#75715e>/*  */</span>, <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>String</span>, <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>StringVar</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>optionLineIndex</span>       = <span style=color:#a6e22e>defineFlagValue</span>(<span style=color:#e6db74>&#34;l&#34;</span>, <span style=color:#e6db74>&#34;line-index&#34;</span> <span style=color:#75715e>/*   */</span>, <span style=color:#e6db74>&#34;Index of line&#34;</span> <span style=color:#75715e>/*                                  */</span>, <span style=color:#ae81ff>10</span> <span style=color:#75715e>/*                         */</span>, <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Int</span>, <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>IntVar</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>optionDurationWaitSec</span> = <span style=color:#a6e22e>defineFlagValue</span>(<span style=color:#e6db74>&#34;w&#34;</span>, <span style=color:#e6db74>&#34;wait-seconds&#34;</span> <span style=color:#75715e>/* */</span>, <span style=color:#e6db74>&#34;Duration of wait seconds (e.g., 500ms, 3s, 2m)&#34;</span> <span style=color:#75715e>/* */</span>, <span style=color:#ae81ff>1</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> <span style=color:#75715e>/*              */</span>, <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Duration</span>, <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>DurationVar</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>optionDebug</span>           = <span style=color:#a6e22e>defineFlagValue</span>(<span style=color:#e6db74>&#34;d&#34;</span>, <span style=color:#e6db74>&#34;debug&#34;</span> <span style=color:#75715e>/*        */</span>, <span style=color:#e6db74>&#34;Debug mode&#34;</span> <span style=color:#75715e>/*                                     */</span>, <span style=color:#66d9ef>false</span> <span style=color:#75715e>/*                      */</span>, <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Bool</span>, <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>BoolVar</span>)
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>init</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Usage</span> = <span style=color:#a6e22e>customUsage</span>(<span style=color:#a6e22e>commandDescription</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Parse</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>optionFilePath</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;\n[ERROR] Missing required option\n\n&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Usage</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Exit</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>optionsUsage</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getOptionsUsage</span>(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;[ Command options ]\n%s\n&#34;</span>, <span style=color:#a6e22e>optionsUsage</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// =======================================</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// flag Utils</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// =======================================</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Helper function for flag</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>defineFlagValue</span>[<span style=color:#a6e22e>T</span> <span style=color:#a6e22e>comparable</span>](<span style=color:#a6e22e>short</span>, <span style=color:#a6e22e>long</span>, <span style=color:#a6e22e>description</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>defaultValue</span> <span style=color:#a6e22e>T</span>, <span style=color:#a6e22e>flagFunc</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>value</span> <span style=color:#a6e22e>T</span>, <span style=color:#a6e22e>usage</span> <span style=color:#66d9ef>string</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>T</span>, <span style=color:#a6e22e>flagVarFunc</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>T</span>, <span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>value</span> <span style=color:#a6e22e>T</span>, <span style=color:#a6e22e>usage</span> <span style=color:#66d9ef>string</span>)) <span style=color:#f92672>*</span><span style=color:#a6e22e>T</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flagUsage</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>short</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>UsageDummy</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>description</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>zero</span> <span style=color:#a6e22e>T</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>defaultValue</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>zero</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>flagUsage</span> = <span style=color:#a6e22e>flagUsage</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34; (default %v)&#34;</span>, <span style=color:#a6e22e>defaultValue</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>f</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>flagFunc</span>(<span style=color:#a6e22e>long</span>, <span style=color:#a6e22e>defaultValue</span>, <span style=color:#a6e22e>flagUsage</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flagVarFunc</span>(<span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>short</span>, <span style=color:#a6e22e>defaultValue</span>, <span style=color:#a6e22e>UsageDummy</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>f</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Custom usage message</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>customUsage</span>(<span style=color:#a6e22e>description</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>optionsUsage</span>, <span style=color:#a6e22e>requiredOptionExample</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getOptionsUsage</span>(<span style=color:#66d9ef>false</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprintf</span>(<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>CommandLine</span>.<span style=color:#a6e22e>Output</span>(), <span style=color:#e6db74>&#34;Usage: %s %s[OPTIONS]\n\n&#34;</span>, <span style=color:#66d9ef>func</span>() <span style=color:#66d9ef>string</span> { <span style=color:#a6e22e>e</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Executable</span>(); <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Base</span>(<span style=color:#a6e22e>e</span>) }(), <span style=color:#a6e22e>requiredOptionExample</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprintf</span>(<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>CommandLine</span>.<span style=color:#a6e22e>Output</span>(), <span style=color:#e6db74>&#34;Description:\n  %s\n\n&#34;</span>, <span style=color:#a6e22e>description</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprintf</span>(<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>CommandLine</span>.<span style=color:#a6e22e>Output</span>(), <span style=color:#e6db74>&#34;Options:\n%s&#34;</span>, <span style=color:#a6e22e>optionsUsage</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Get options usage message</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getOptionsUsage</span>(<span style=color:#a6e22e>currentValue</span> <span style=color:#66d9ef>bool</span>) (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>requiredOptionExample</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>optionNameWidth</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>usages</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>string</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>getType</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>v</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>NewReplacer</span>(<span style=color:#e6db74>&#34;*flag.boolValue&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;*flag.&#34;</span>, <span style=color:#e6db74>&#34;&lt;&#34;</span>, <span style=color:#e6db74>&#34;Value&#34;</span>, <span style=color:#e6db74>&#34;&gt;&#34;</span>).<span style=color:#a6e22e>Replace</span>(<span style=color:#a6e22e>v</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>VisitAll</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>f</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Flag</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>optionNameWidth</span> = max(<span style=color:#a6e22e>optionNameWidth</span>, len(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%s %s&#34;</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#a6e22e>getType</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%T&#34;</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Value</span>))))<span style=color:#f92672>+</span><span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>VisitAll</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>f</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Flag</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Usage</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>UsageDummy</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>value</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getType</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%T&#34;</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Value</span>))
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>currentValue</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>value</span> = <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Value</span>.<span style=color:#a6e22e>String</span>()
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>short</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Split</span>(<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Usage</span>, <span style=color:#a6e22e>UsageDummy</span>)[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>mainUsage</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Split</span>(<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Usage</span>, <span style=color:#a6e22e>UsageDummy</span>)[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Contains</span>(<span style=color:#a6e22e>mainUsage</span>, <span style=color:#a6e22e>Req</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>requiredOptionExample</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;--%s %s &#34;</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#a6e22e>value</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>usages</span> = append(<span style=color:#a6e22e>usages</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;  -%-1s, --%-&#34;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Itoa</span>(<span style=color:#a6e22e>optionNameWidth</span>)<span style=color:#f92672>+</span><span style=color:#e6db74>&#34;s %s\n&#34;</span>, <span style=color:#a6e22e>short</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Name</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#34; &#34;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>value</span>, <span style=color:#a6e22e>mainUsage</span>))
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sort</span>.<span style=color:#a6e22e>SliceStable</span>(<span style=color:#a6e22e>usages</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>j</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Count</span>(<span style=color:#a6e22e>usages</span>[<span style=color:#a6e22e>i</span>], <span style=color:#a6e22e>Req</span>) &gt; <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Count</span>(<span style=color:#a6e22e>usages</span>[<span style=color:#a6e22e>j</span>], <span style=color:#a6e22e>Req</span>)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>usages</span>, <span style=color:#e6db74>&#34;&#34;</span>), <span style=color:#a6e22e>requiredOptionExample</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=実装の解説>実装の解説</h2><p>使うときは意識しなくて良いのですが、多少複雑なので何をやってるのかを簡単に解説します。</p><h3 id=defineflagvalue>defineFlagValue</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>optionFilePath</span>   = <span style=color:#a6e22e>defineFlagValue</span>(<span style=color:#e6db74>&#34;f&#34;</span>, <span style=color:#e6db74>&#34;file-path&#34;</span> <span style=color:#75715e>/*  */</span>, <span style=color:#a6e22e>Req</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#34; File path&#34;</span> <span style=color:#75715e>/* */</span>, <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#75715e>/*     */</span>, <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>String</span>, <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>StringVar</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>optionLineIndex</span>  = <span style=color:#a6e22e>defineFlagValue</span>(<span style=color:#e6db74>&#34;l&#34;</span>, <span style=color:#e6db74>&#34;line-index&#34;</span> <span style=color:#75715e>/* */</span>, <span style=color:#e6db74>&#34;Index of line&#34;</span> <span style=color:#75715e>/*  */</span>, <span style=color:#ae81ff>10</span> <span style=color:#75715e>/*     */</span>, <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Int</span>, <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>IntVar</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>optionDebug</span>      = <span style=color:#a6e22e>defineFlagValue</span>(<span style=color:#e6db74>&#34;d&#34;</span>, <span style=color:#e6db74>&#34;debug&#34;</span> <span style=color:#75715e>/*      */</span>, <span style=color:#e6db74>&#34;Debug mode&#34;</span> <span style=color:#75715e>/*     */</span>, <span style=color:#66d9ef>false</span> <span style=color:#75715e>/*  */</span>, <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Bool</span>, <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>BoolVar</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>defineFlagValue</span>[<span style=color:#a6e22e>T</span> <span style=color:#a6e22e>comparable</span>](<span style=color:#a6e22e>short</span>, <span style=color:#a6e22e>long</span>, <span style=color:#a6e22e>description</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>defaultValue</span> <span style=color:#a6e22e>T</span>, <span style=color:#a6e22e>flagFunc</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>value</span> <span style=color:#a6e22e>T</span>, <span style=color:#a6e22e>usage</span> <span style=color:#66d9ef>string</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>T</span>, <span style=color:#a6e22e>flagVarFunc</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>T</span>, <span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>value</span> <span style=color:#a6e22e>T</span>, <span style=color:#a6e22e>usage</span> <span style=color:#66d9ef>string</span>)) <span style=color:#f92672>*</span><span style=color:#a6e22e>T</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flagUsage</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>short</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>UsageDummy</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>description</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>zero</span> <span style=color:#a6e22e>T</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>defaultValue</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>zero</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>flagUsage</span> = <span style=color:#a6e22e>flagUsage</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34; (default %v)&#34;</span>, <span style=color:#a6e22e>defaultValue</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>f</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>flagFunc</span>(<span style=color:#a6e22e>long</span>, <span style=color:#a6e22e>defaultValue</span>, <span style=color:#a6e22e>flagUsage</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flagVarFunc</span>(<span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>short</span>, <span style=color:#a6e22e>defaultValue</span>, <span style=color:#a6e22e>UsageDummy</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>f</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>いきなり独自実装が出てきました。
これは、ショートオプションとロングオプションの両方を同じ意味で定義するためのヘルパー関数です。
ショートオプション名、ロングオプション名、説明文、デフォルト値を指定すると、両方のオプションを同じ変数にバインドします。
<code>flag.String</code> や <code>flag.Int</code> のような関数と同じものですね。</p><p>ポイントは以下の2点です。</p><ul><li><code>short + UsageDummy + description</code><ul><li>Usage の先頭にショートオプション名を埋め込んでいます。</li><li>後の処理で、 Usage をパースしてショートオプション名を取得するために使います。</li></ul></li><li><code>if defaultValue != zero {...}</code><ul><li>デフォルト値が指定されている場合、 Usage の説明文にデフォルト値を含めています。</li><li>後の処理で Usage を表示時にデフォルト値が表示されるようにするためです。</li></ul></li></ul><p>ちなみにこの関数は、Go 1.18 で導入された Generics を使って実装しています。
もし Generics なかったら同じ実装を大量にコピペしないといけなかったので、めちゃくちゃ助かりました!!</p><p>あ、あと <code>/* */,</code> のようなコメントブロックを入れてる理由は、
defineFlagValue の引数の位置が縦に揃うとパッとみた時に各種オプションの値が分かりやすくなるので可読性のために入れてます。</p><h3 id=customusage>customUsage</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Custom usage message</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>customUsage</span>(<span style=color:#a6e22e>description</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>optionsUsage</span>, <span style=color:#a6e22e>requiredOptionExample</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getOptionsUsage</span>(<span style=color:#66d9ef>false</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprintf</span>(<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>CommandLine</span>.<span style=color:#a6e22e>Output</span>(), <span style=color:#e6db74>&#34;Usage: %s %s[OPTIONS]\n\n&#34;</span>, <span style=color:#66d9ef>func</span>() <span style=color:#66d9ef>string</span> { <span style=color:#a6e22e>e</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Executable</span>(); <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Base</span>(<span style=color:#a6e22e>e</span>) }(), <span style=color:#a6e22e>requiredOptionExample</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprintf</span>(<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>CommandLine</span>.<span style=color:#a6e22e>Output</span>(), <span style=color:#e6db74>&#34;Description:\n  %s\n\n&#34;</span>, <span style=color:#a6e22e>description</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprintf</span>(<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>CommandLine</span>.<span style=color:#a6e22e>Output</span>(), <span style=color:#e6db74>&#34;Options:\n%s&#34;</span>, <span style=color:#a6e22e>optionsUsage</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ここは前回紹介した Custom Usage の実装とほぼ同じです。
Usage メッセージのフォーマットを定義しています。
が、前回と違うのは <code>getOptionsUsage</code> 関数を呼び出して、オプション一覧の表示と、必須オプションの例示部分（一行目のやつ）を取得している点です。</p><h3 id=getoptionsusage>getOptionsUsage</h3><p>ここが今回のキモの部分です。
この関数は、 <code>flag.VisitAll</code> で登録されているすべてのオプションを走査し、 Custom Usage の &ldquo;オプション一行表示&rdquo; のフォーマットに合わせた Usage を生成します。
この時、必須オプションを検出して、 Usage の1行目に例示するための文字列も同時に生成し、関数の戻り値として返します。</p><p>前回の方法は、 flag パッケージの標準の Usage 出力をパースして整形していたのですが、今回はオプション名の横幅を動的に調整したり、ロングオプション名を追加したりする必要があるため、標準の Usage 出力をパースする方法は使えません。
このため、 <code>flag.VisitAll</code> でオプションを1つずつ走査して、 Usage を組み立てる方法を採用しています。
前回の記事を読んだ方がもしいらっしゃったら、「デフォルト値取得できないんじゃなかったの？」と思われるかもしれません。
そこはその通りで、flag が出力する default 値は VisitAll では取得できません。</p><p>今回どうやっているのかというと、 <code>defineFlagValue</code> のヘルパー関数を使ってオプションを定義している処理の中で</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>defaultValue</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>zero</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flagUsage</span> = <span style=color:#a6e22e>flagUsage</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34; (default %v)&#34;</span>, <span style=color:#a6e22e>defaultValue</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>というようなことをやってます（「defineFlagValue」でも説明した内容です）。
これはつまり、指定されたデフォルト値がその型の初期値かどうかチェックし、
もし初期値と異なる値だった場合は &ldquo;オプションの説明文に文字列として含めてしまう&rdquo; というような方法で対処してます。
こうすることで、 VisitAll で取得された Usage 文字列をそのまま表示するだけで、デフォルト値も表示できるようになります。</p><p>また、 <code>f.Usage</code> をパースして、ショートオプション名と メインのオプション説明文を分離し、フォーマットに合わせて組み立て直しています。</p><p>（便利機能として、ヘルプ表示時の文字列組み立ての他に、実行時に現在のオプション値を表示するためにも使えるようにしています。）</p><h2 id=まとめ>まとめ</h2><p>Go 標準の flag パッケージだけでロングオプションをサポートする方法を紹介しました。
main.go のみでツールを実装したいんだけど、お手軽にロングオプションをサポートしたい、という場合にもしかすると使えるかもしれません。
（人にスクリプトやバイナリを渡してヘルプ表示してもらった時に「お？」と思ってもらえると良いなと思ってます）
ではでは。</p></div></article></main><footer class="w-full p-md border-t border-border bg-surface"><div class="max-w-max mx-auto flex justify-between items-center text-sm text-tertiary"><p>&copy; 2026 xshoji's blog. Crafted in Tokyo. All rights reserved.</p><nav class="social-links flex gap-md"><a href=https://github.com/xshoji target=_blank rel=noopener class="text-tertiary font-medium transition-fast hover:text-accent border-none">GitHub</a>
<a href=https://x.com/xshoji2020 target=_blank rel=noopener class="text-tertiary font-medium transition-fast hover:text-accent border-none">X</a>
<a href=/index.xml class="text-tertiary font-medium transition-fast hover:text-accent border-none">RSS</a></nav></div></footer></body></html>