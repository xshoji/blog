<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>SQLインジェクションフィルタを回避するためのアプローチ
| xshoji</title><link rel=stylesheet href=https://blog.xshoji.com/css/site.min.5b92094b89c75bcdd147f48b97e2316a552fe8e8fd10c9bcec6f9270da85c58430668afdaa5479cde87d4e462bea134e7c6f7a22c060c65d1c1e0c1ab2344359.css integrity="sha512-W5IJS4nHW83RR/SLl+IxalUv6Oj9EMm87G+ScNqFxYQwZor9qlR5zeh9TkYr6hNOfG96IsBgxl0cHgwasjRDWQ=="><link rel=canonical href=https://blog.xshoji.com/posts/20200920_an-approach-to-avoid-sql-injection-filters/><link rel=alternate type=application/rss+xml href=https://blog.xshoji.com/index.xml title="xshoji's tech blog"><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><meta name=author content="xshoji"><meta name=description content="Astrocamel - Blog/Portfolio of George Skouroupathis https://www.astrocamel.com/web/2020/09/04/how-i-bypassed-cloudflares-sql-injection-filter.html が元の記事で、さらっとまとめると Cloudflareを使ってるサイトの脆弱性試験しようとしたら、そもそもサイトまでリクエストが"><meta property="og:title" content="SQLインジェクションフィルタを回避するためのアプローチ"><meta property="og:description" content="Astrocamel - Blog/Portfolio of George Skouroupathis https://www.astrocamel.com/web/2020/09/04/how-i-bypassed-cloudflares-sql-injection-filter.html が元の記事で、さらっとまとめると Cloudflareを使ってるサイトの脆弱性試験しようとしたら、そもそもサイトまでリクエストが"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.xshoji.com/posts/20200920_an-approach-to-avoid-sql-injection-filters/"><meta property="article:published_time" content="2020-09-20T19:00:00+09:00"><meta property="article:modified_time" content="2020-09-20T19:00:00+09:00"></head><body><nav class="navbar is-transparent" role=navigation aria-label="main navigation"><div class=navbar-brand><a class=navbar-item href=https://blog.xshoji.com/><figure class=image><img alt class=is-rounded src="https://www.gravatar.com/avatar/dae9579b0a2b7e5f2872d705f228d321?s=128&d=identicon"></figure></a><a class=navbar-item href=https://blog.xshoji.com/>xshoji's tech blog</a></div><div class=navbar-menu><div class=navbar-start><a class=navbar-item href=https://blog.xshoji.com/tags/posts/>Posts</a></div><div class=navbar-end><a class=navbar-item href=https://github.com/xshoji/ rel=noopener target=_blank><span class=icon><img alt=icons/svg/github.svg src=https://blog.xshoji.com/icons/svg/github.svg></span></a>
<a class=navbar-item href=mailto:shoji.cx@gmail.com target=_blank><span class=icon><img alt=email src=https://blog.xshoji.com/icons/svg/email.svg></span></a>
<a class=navbar-item href=https://blog.xshoji.com/index.xml target=_blank><span class=icon><img alt=rss src=https://blog.xshoji.com/icons/svg/rss.svg></span></a></div></div></nav><section><section class="hero is-small is-dark is-fullwidth"><div class=hero-body><div class=container><h1 class=title>SQLインジェクションフィルタを回避するためのアプローチ</h1><h2 class=subtitle><time datetime=2020-09-20T19:00:00+09:00>September 20, 2020</time><br><a class="tag is-link" href=https://blog.xshoji.com/tags/posts/>posts</a></h2></div></div></section><section class=section><div class=container><div class="content is-medium"><blockquote><p>Astrocamel - Blog/Portfolio of George Skouroupathis<br><a href=https://www.astrocamel.com/web/2020/09/04/how-i-bypassed-cloudflares-sql-injection-filter.html>https://www.astrocamel.com/web/2020/09/04/how-i-bypassed-cloudflares-sql-injection-filter.html</a></p></blockquote><p>が元の記事で、さらっとまとめると</p><blockquote><p>Cloudflareを使ってるサイトの脆弱性試験しようとしたら、そもそもサイトまでリクエストが届いてないことが判明<br>CloudflareのWAFで弾かれてるっぽいから、SQLのリクエスト難読化したら無事突破できたよ</p></blockquote><p>って話です。この機能を回避するアプローチが面白かった。
ここでいう「難読化（obfuscation）」っていうのは、
SQLの意味はそのままに、Cloudflareのフィルタをパスできるクエリの加工のことのようです。
（CDNのレイヤで、リクエストの中身まで見て攻撃を防ぐみたいなことしてるの知らなかった・・・。）</p><p>あと、目的のサイトの脆弱性試験しようとしたら、Cloudflareの脆弱性試験になってるやんっていう。</p><p>具体的な流れのサマリーは以下の通り。</p><ol><li>脆弱性試験の対象サイトはMySQL + PHPのよくあるサイト</li><li>POSTリクエストでTime-based SQL Injection使って試験しようとした</li><li>何故かリクエストがサイトに届かない</li><li>CloudflareのWAF（SQLインジェクションフィルタ）で弾かれてるっぽい</li><li>どういうリクエストが弾かれるか調べよう</li><li>文字とか=とかをPOSTすると弾かれるっぽい</li><li>いろいろSQL難読化したら無事突破できました</li><li>無事突破したことをCloudflareに報告したらTシャツゲットしたよ</li></ol><p>みたいなことのようです。ここで出てくる「Time-based SQL Injection」ってのは、</p><blockquote><p>Time-based SQL Injectionは意外に実用的だった ｜ 徳丸浩の日記<br><a href=https://blog.tokumaru.org/2015/04/time-based-sql-injection.html>https://blog.tokumaru.org/2015/04/time-based-sql-injection.html</a></p><p>Time-based SQL Injectionとは&mldr;<br>特定の条件にヒットする場合にのみ一定秒数Sleepする、というSQL（sleep()関数とかを使って）をInjectionすることで、 ヒットする場合としない場合の応答時間の差を利用して情報を盗む手法のこと。</p></blockquote><p>らしいです。へー。
（後で気づいたけど、かの有名な徳丸さんのサイトだった）</p><p>あ、あと全部のSQLインジェクションが弾かれるわけではなかったみたいなのでそこは注意。</p><p>結局この人の場合、Time-based SQL Injectionという手法が使えなかったため、
その時に試すことができたSQLインジェクションを使って、</p><ul><li>結果が返りうるSQLをインジェクション（例：<code>... WHERE 'a' = 'a'</code>）: 200 OK</li><li>結果が返らないSQLをインジェクション（例：<code>... WHERE 'a' = 'b'</code>）: 500 Internal Server Error</li></ul><p>となる特性を発見し、これを利用してテーブル名やカラム名の特定を行う方法を探っていったみたい。</p><p>で、どうやって特定するのかというと、テーブルやカラム名が格納されているDBのメタテーブルに対して、</p><blockquote><p>WHERE &lsquo;a&rsquo; = メタテーブルの中のテーブル名の1文字目<br>WHERE &lsquo;b&rsquo; = メタテーブルの中のテーブル名の1文字目<br>&mldr; と繰り返す。1文字目が分かったら<br>WHERE &lsquo;a&rsquo; = メタテーブルの中のテーブル名の2文字目<br>WHERE &lsquo;b&rsquo; = メタテーブルの中のテーブル名の2文字目<br>&mldr; と繰り返す。以下繰り返し</p></blockquote><p>って感じでブルートフォース攻撃を行ったらしい。
この比較を行うSQLが実行されると、↑の通りサーバーとしては</p><ul><li>合ってたら: <code>200 OK</code></li><li>間違いなら: <code>500 Internal Server Error</code></li></ul><p>となり、がっつりチェック可能ということになります。</p><p>で、具体的にどういうふうにSQLを難読化したかについては元の記事に詳しく載っているのでそちらを参照ください。</p><p>所感として、SQLインジェクション自体をさせないことも重要だけど、
エラーハンドリングが甘いと↑のように攻撃者に手がかりを与えてしまうことになるなーと痛感しました。</p></div></div></section></section><footer class=footer><div class="content has-text-centered"><p><a href=https://github.com/orf/bare-hugo-theme target=_blank>Bare Hugo theme.</a>
Blog source code <a href=https://github.com/xshoji/blog target=_blank>available on Github</a>.</p></div></footer></body></html>