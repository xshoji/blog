<!doctype html><html lang=ja dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>Posts | xshoji's blog</title><link rel=icon type=image/x-icon href=/favicon.ico><link rel=stylesheet href=/css/main.7b7b848004ec22186d0f48cbdeabe685e1fbd5f2ddb409caa8cbcf7c139c950c.css integrity="sha256-e3uEgATsIhhtD0jL3qvmheH71fLdtAnKqMvPfBOclQw=" crossorigin=anonymous><script src=/js/main.8efc561a4853c73f6c3decb3b33a80113fbca97ca17c301baa4b06eed7f353e5.js integrity="sha256-jvxWGkhTxz9sPeyzszqAET+8qXyhfDAbqksG7tfzU+U=" crossorigin=anonymous defer></script><script src=/js/lightbox.550e4d90ea59c55fb90b08fc2da070e791ab087d60cc52a932b5a5e5a2037547.js integrity="sha256-VQ5NkOpZxV+5Cwj8LaBw55GrCH1gzFKpMrWl5aIDdUc=" crossorigin=anonymous defer></script></head><body><header class="w-full px-4 py-3 md:p-6 border-b border-border bg-surface sticky top-0 z-50 backdrop-blur bg-surface-alpha transition-all duration-150 will-change-transform"><div id=translate-banner class="translate-banner max-w-max mx-auto py-2 px-6 text-sm text-text-tertiary text-center" hidden><a id=translate-link href=# target=_blank rel=noopener class="font-medium transition duration-150 hover:text-accent border-none text-text-tertiary">🌐 <span id=translate-text></span></a></div><div class="max-w-layout mx-auto flex justify-between items-center transition"><h1 class="blog-name text-sm md:text-lg font-sans font-semibold tracking-tight m-0 transition transform-origin-left whitespace-nowrap"><a href=/ class="text-text-primary border-b border-transparent hover:text-accent transition">xshoji's blog</a></h1><nav class="blog-menu m-0 transition duration-150"><ul class="list-none flex gap-6 md:gap-10 items-center"><li class="mb-0 leading-relaxed"><a class="nav-link text-sm font-medium tracking-sm uppercase text-text-secondary border-none py-2 pb-2 relative" href=/about/>About</a></li><li class="mb-0 leading-relaxed"><a class="nav-link text-sm font-medium tracking-sm uppercase text-text-secondary border-none py-2 pb-2 relative" href=/tags/>Tags</a></li><li class="mb-0 leading-relaxed"><a class="nav-link text-sm font-medium tracking-sm uppercase text-text-secondary border-none py-2 pb-2 relative" href=/search/>Search</a></li></ul></nav></div></header><main><article class="max-w-content mx-auto"><header class=mb-12><div class="post-meta flex flex-wrap gap-2 items-center text-xs text-text-tertiary uppercase tracking-wider font-semibold mb-6"><time class=text-accent datetime=2026-01-03T01:56:07+09:00>2026-01-03
</time><span class="w-5 h-px bg-border"></span>
<span class="ml-auto text-right whitespace-nowrap">8 min read</span>
<time class="w-full text-xs text-text-tertiary opacity-85" datetime=2026-01-12T04:02:14+09:00>2026-01-12 <span>(updated)</span></time></div><h1 class="post-title text-2xl font-sans font-semibold leading-snug mt-2 mb-2"><a href=https://blog.xshoji.com/posts/20260103_golang-flag-pretty-usage/ class="text-text-primary border-b border-transparent hover:text-accent">Go 標準の flag パッケージのテクニック集その1: Usageを綺麗に整形して見やすくする</a></h1><div class="flex gap-2 flex-wrap"><a href=/tags/golang/ class="text-xs px-[0.8rem] py-[0.3rem] bg-accent-light text-accent rounded font-medium tracking-sm border-transparent transition duration-150 hover:bg-accent hover:text-surface hover:border-accent hover:-translate-y-1">#golang</a>
<a href=/tags/go/ class="text-xs px-[0.8rem] py-[0.3rem] bg-accent-light text-accent rounded font-medium tracking-sm border-transparent transition duration-150 hover:bg-accent hover:text-surface hover:border-accent hover:-translate-y-1">#go</a>
<a href=/tags/flag/ class="text-xs px-[0.8rem] py-[0.3rem] bg-accent-light text-accent rounded font-medium tracking-sm border-transparent transition duration-150 hover:bg-accent hover:text-surface hover:border-accent hover:-translate-y-1">#flag</a>
<a href=/tags/cli/ class="text-xs px-[0.8rem] py-[0.3rem] bg-accent-light text-accent rounded font-medium tracking-sm border-transparent transition duration-150 hover:bg-accent hover:text-surface hover:border-accent hover:-translate-y-1">#cli</a>
<a href=/tags/command-line/ class="text-xs px-[0.8rem] py-[0.3rem] bg-accent-light text-accent rounded font-medium tracking-sm border-transparent transition duration-150 hover:bg-accent hover:text-surface hover:border-accent hover:-translate-y-1">#command-line</a>
<a href=/tags/usage/ class="text-xs px-[0.8rem] py-[0.3rem] bg-accent-light text-accent rounded font-medium tracking-sm border-transparent transition duration-150 hover:bg-accent hover:text-surface hover:border-accent hover:-translate-y-1">#usage</a></div></header><details id=TableOfContents aria-label=目次><summary><h3 class="text-sm font-semibold mt-0 mb-4 opacity-75">目次</h3></summary><nav id=TableOfContents><ul><li><a href=#custom-usage-で見やすくしてるポイント>Custom Usage で見やすくしてるポイント</a><ul><li><a href=#正確な実行バイナリ名を表示する>正確な実行バイナリ名を表示する</a></li><li><a href=#コマンドの説明文の表示>コマンドの説明文の表示</a></li><li><a href=#オプション一覧が一行で表示される>オプション一覧が一行で表示される</a></li><li><a href=#必須のオプションがどれか分かりやすい上位に表示される>必須のオプションがどれか分かりやすい（上位に表示される）</a></li></ul></li><li><a href=#custom-usage-のスニペットを紹介>Custom Usage のスニペットを紹介</a><ul><li></li><li><a href=#必須オプションのチェックについて>必須オプションのチェックについて</a></li></ul></li><li><a href=#スニペットの説明>スニペットの説明</a></li><li><a href=#ヘルプ表示について>ヘルプ表示について</a></li><li><a href=#custom-usage-を使った完全な-maingo-のテンプレート>Custom Usage を使った完全な main.go のテンプレート</a></li><li><a href=#まとめ>まとめ</a></li></ul></nav></details><div class="article-content text-base leading-[1.7] text-text-secondary"><p>業務でちょっとした検証用のツールや、調査用のコマンドラインアプリケーションを Go 言語で作成することがよくあります。
基本自分しか使わないのですが、何かきっかけでスクリプトを他の人に配ることもあり、このとき <code>main.go</code> のみで完結するようにしておくと、人に配るときや何らかの証跡と一緒に残しておく際もテキストファイル一つ渡せば済むので大変便利です。
また、配布先の人がビルドする時もトラブルが少ないです。
このため、外部のライブラリが必ず必要という状況でない限りは、できるだけ Go 標準ライブラリだけでツールを作成するようにしています。</p><p>ただ、Go 標準の <code>flag</code> パッケージはコマンドライン引数のパースを簡単に実装できる反面、 Usage の出力があまり綺麗ではなかったり、ロングオプションを扱うのが難しいなど色々使い勝手が悪い部分があります。
先ほど説明した通り、 main.go のみで実装することにこだわりたかったため、これまで、 <a href=https://github.com/spf13/cobra class="text-accent no-underline border-b border-accent hover:text-text-primary hover:border-transparent relative transition-[border-color,color]">spf13/cobra</a>
や <a href=https://github.com/urfave/cli class="text-accent no-underline border-b border-accent hover:text-text-primary hover:border-transparent relative transition-[border-color,color]">urfave/cli</a>
のような外部ライブラリを使わずに、どうにかして Usage を綺麗にしたり ロングオプションを扱えるようにしたりできないか試行錯誤したので、その実装方法について何回かに分けて紹介したいと思います。</p><p>今回は「 <strong>Usage を綺麗に整形して見やすくする</strong> 」方法について紹介します。
ここで紹介する方法（以降、呼びやすさのために「 Custom Usage 」と表現します）を使うと、標準の flag パッケージだけで以下のような綺麗な Usage を出力できるようになります。</p><div class="highlight my-[var(--space-md)]"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4 class="p-[var(--space-sm)] pt-[calc(var(--space-sm)*1.1)] md:p-[var(--space-md)] rounded-[4px] overflow-x-auto text-[0.75rem] md:text-[var(--text-sm)] leading-[1.6]"><code class="language-plaintext bg-transparent p-0 text-inherit whitespace-pre inline-block [-webkit-text-size-adjust:none]" data-lang=plaintext><span style=display:flex><span>$ go run main.go -h
</span></span><span style=display:flex><span>Usage: main [OPTIONS]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Description:
</span></span><span style=display:flex><span>  A sample command demonstrating simple template usage in Go CLI applications.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Options:
</span></span><span style=display:flex><span>  -f &lt;string&gt;      (required) File path
</span></span><span style=display:flex><span>  -d               Debug mode
</span></span><span style=display:flex><span>  -l &lt;int&gt;         Index of line (default 10)
</span></span><span style=display:flex><span>  -u &lt;string&gt;      URL (default &#34;https://httpbin.org/get&#34;)
</span></span><span style=display:flex><span>  -w &lt;duration&gt;    Duration of wait seconds (e.g., 1s, 500ms, 2m) (default 1s)</span></span></code></pre></div><p>Go 標準の <code>flag</code> パッケージだけにしては結構見やすくなっているのではないでしょうか？
興味があれば、ぜひ詳細を読んでみてください。</p><h2 id=custom-usage-で見やすくしてるポイント style=font-family:var(--font-serif) class="leading-[1.2] tracking-[-0.02em] text-text-primary mt-[var(--space-md)] mb-[var(--space-md)] scroll-mt-[calc(var(--space-md)*2*1.2)] transition-colors font-medium text-[1.5rem]">Custom Usage で見やすくしてるポイント</h2><p>改めて</p><ul><li>flag デフォルトの Usage</li><li>Custom Usage</li></ul><p>の違いを見てみます。</p><p><strong>Before: flag デフォルトの Usage</strong></p><div class="highlight my-[var(--space-md)]"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4 class="p-[var(--space-sm)] pt-[calc(var(--space-sm)*1.1)] md:p-[var(--space-md)] rounded-[4px] overflow-x-auto text-[0.75rem] md:text-[var(--text-sm)] leading-[1.6]"><code class="language-plaintext bg-transparent p-0 text-inherit whitespace-pre inline-block [-webkit-text-size-adjust:none]" data-lang=plaintext><span style=display:flex><span>$ go run main.go -h
</span></span><span style=display:flex><span>Usage of /var/folders/vv/fc_khb3904d2d0_rz86jxhv00000gn/T/go-build1709560788/b001/exe/main:
</span></span><span style=display:flex><span>  -d    Debug mode
</span></span><span style=display:flex><span>  -f string
</span></span><span style=display:flex><span>        (required) File path
</span></span><span style=display:flex><span>  -l int
</span></span><span style=display:flex><span>        Index of line (default 10)
</span></span><span style=display:flex><span>  -u string
</span></span><span style=display:flex><span>        URL (default &#34;https://httpbin.org/get&#34;)
</span></span><span style=display:flex><span>  -w duration
</span></span><span style=display:flex><span>        Duration of wait seconds (e.g., 1s, 500ms, 2m) (default 1s)</span></span></code></pre></div><p><strong>After: Custom Usage</strong></p><div class="highlight my-[var(--space-md)]"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4 class="p-[var(--space-sm)] pt-[calc(var(--space-sm)*1.1)] md:p-[var(--space-md)] rounded-[4px] overflow-x-auto text-[0.75rem] md:text-[var(--text-sm)] leading-[1.6]"><code class="language-plaintext bg-transparent p-0 text-inherit whitespace-pre inline-block [-webkit-text-size-adjust:none]" data-lang=plaintext><span style=display:flex><span>$ go run main.go -h
</span></span><span style=display:flex><span>Usage: main [OPTIONS]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Description:
</span></span><span style=display:flex><span>  A sample command demonstrating simple template usage in Go CLI applications.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Options:
</span></span><span style=display:flex><span>  -f &lt;string&gt;      (required) File path
</span></span><span style=display:flex><span>  -d               Debug mode
</span></span><span style=display:flex><span>  -l &lt;int&gt;         Index of line (default 10)
</span></span><span style=display:flex><span>  -u &lt;string&gt;      URL (default &#34;https://httpbin.org/get&#34;)
</span></span><span style=display:flex><span>  -w &lt;duration&gt;    Duration of wait seconds (e.g., 1s, 500ms, 2m) (default 1s)</span></span></code></pre></div><p>標準の flag パッケージの Usage は、フラグの名前と説明文が揃っておらず若干見づらくないですか？自分はここが結構気になってしまって、今回紹介する Custom Usage を作成しました。
では、Custom Usage で見やすくしているポイントを具体的に見ていきます。</p><h3 id=正確な実行バイナリ名を表示する style=font-family:var(--font-serif) class="leading-[1.2] tracking-[-0.02em] text-text-primary mt-[var(--space-md)] mb-[var(--space-md)] scroll-mt-[calc(var(--space-md)*2*1.2)] transition-colors font-medium text-[1.125rem]">正確な実行バイナリ名を表示する</h3><div class="highlight my-[var(--space-md)]"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4 class="p-[var(--space-sm)] pt-[calc(var(--space-sm)*1.1)] md:p-[var(--space-md)] rounded-[4px] overflow-x-auto text-[0.75rem] md:text-[var(--text-sm)] leading-[1.6]"><code class="language-plaintext bg-transparent p-0 text-inherit whitespace-pre inline-block [-webkit-text-size-adjust:none]" data-lang=plaintext><span style=display:flex><span>$ go run main.go -h
</span></span><span style=display:flex><span>Usage: main [OPTIONS]
</span></span><span style=display:flex><span>...</span></span></code></pre></div><p>通常 Go の <code>flag</code> パッケージを使うと、 <code>Usage</code> 出力時に <code>Usage of {os.Args[0]}</code> のような仕様で文字列が表示されます。
この <code>os.Args[0]</code> は実行したコマンドラインの最初の引数、つまり実行バイナリ名が通常入るのですが、厳密にいうと実行方法によっては実行されたバイナリ名にならないことがあります。
例えばシェルスクリプト等の中で <code>exec -a "hoge" ./mycli ...</code> のようにプロセス名を指定して呼び出した場合や、シンボリックリンク経由で実行した場合などです。</p><p>こういった場合でも正確な実行バイナリ名を表示するために、 Custom Usage では <code>os.Executable()</code> を使って実行バイナリのパスを取得し、 <code>filepath.Base()</code> でファイル名だけを抽出して表示しています。
これにより、どのような実行方法であっても正確な実行バイナリ名がUsageに表示されるようになります。</p><h3 id=コマンドの説明文の表示 style=font-family:var(--font-serif) class="leading-[1.2] tracking-[-0.02em] text-text-primary mt-[var(--space-md)] mb-[var(--space-md)] scroll-mt-[calc(var(--space-md)*2*1.2)] transition-colors font-medium text-[1.125rem]">コマンドの説明文の表示</h3><div class="highlight my-[var(--space-md)]"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4 class="p-[var(--space-sm)] pt-[calc(var(--space-sm)*1.1)] md:p-[var(--space-md)] rounded-[4px] overflow-x-auto text-[0.75rem] md:text-[var(--text-sm)] leading-[1.6]"><code class="language-plaintext bg-transparent p-0 text-inherit whitespace-pre inline-block [-webkit-text-size-adjust:none]" data-lang=plaintext><span style=display:flex><span>Description:
</span></span><span style=display:flex><span>  A sample command demonstrating simple template usage in Go CLI applications.</span></span></code></pre></div><p>ここは好みの問題かもしれませんが、Descriptionがあるだけで一気に &ldquo;ちゃんとしたツール感&rdquo; が出るので、私はいつもコマンドのディスクリプションを表示するようにしてます。</p><h3 id=オプション一覧が一行で表示される style=font-family:var(--font-serif) class="leading-[1.2] tracking-[-0.02em] text-text-primary mt-[var(--space-md)] mb-[var(--space-md)] scroll-mt-[calc(var(--space-md)*2*1.2)] transition-colors font-medium text-[1.125rem]">オプション一覧が一行で表示される</h3><p><strong>今回紹介する Custom Usage の一番の売りがここなんですが、オプション一覧がライブラリを使用したかのように一行で綺麗に表示されるようになります。</strong></p><div class="highlight my-[var(--space-md)]"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4 class="p-[var(--space-sm)] pt-[calc(var(--space-sm)*1.1)] md:p-[var(--space-md)] rounded-[4px] overflow-x-auto text-[0.75rem] md:text-[var(--text-sm)] leading-[1.6]"><code class="language-plaintext bg-transparent p-0 text-inherit whitespace-pre inline-block [-webkit-text-size-adjust:none]" data-lang=plaintext><span style=display:flex><span>Options:
</span></span><span style=display:flex><span>  -f &lt;string&gt;      (required) File path
</span></span><span style=display:flex><span>  -d               Debug mode
</span></span><span style=display:flex><span>  -l &lt;int&gt;         Index of line (default 10)
</span></span><span style=display:flex><span>  -u &lt;string&gt;      URL (default &#34;https://httpbin.org/get&#34;)
</span></span><span style=display:flex><span>  -w &lt;duration&gt;    Duration of wait seconds (e.g., 1s, 500ms, 2m) (default 1s)</span></span></code></pre></div><p>型名を <code>&lt;string></code> のように括弧で括ってるのはフラグ名と値の区別がつきやすくするためで、他のコマンドでも見かけたことがあり、分かりやすかったので採用してます。
（簡単な実装なので、この辺りのフォーマットを好みに応じて変えたい場合はすぐ変えられます）</p><h3 id=必須のオプションがどれか分かりやすい上位に表示される style=font-family:var(--font-serif) class="leading-[1.2] tracking-[-0.02em] text-text-primary mt-[var(--space-md)] mb-[var(--space-md)] scroll-mt-[calc(var(--space-md)*2*1.2)] transition-colors font-medium text-[1.125rem]">必須のオプションがどれか分かりやすい（上位に表示される）</h3><div class="highlight my-[var(--space-md)]"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4 class="p-[var(--space-sm)] pt-[calc(var(--space-sm)*1.1)] md:p-[var(--space-md)] rounded-[4px] overflow-x-auto text-[0.75rem] md:text-[var(--text-sm)] leading-[1.6]"><code class="language-plaintext bg-transparent p-0 text-inherit whitespace-pre inline-block [-webkit-text-size-adjust:none]" data-lang=plaintext><span style=display:flex><span>Options:
</span></span><span style=display:flex><span>  -f &lt;string&gt;      (required) File path ← 必須オプションが一番上に来る
</span></span><span style=display:flex><span>  -d               Debug mode
</span></span><span style=display:flex><span>  -l &lt;int&gt;         Index of line (default 10)
</span></span><span style=display:flex><span>  -u &lt;string&gt;      URL (default &#34;https://httpbin.org/get&#34;)
</span></span><span style=display:flex><span>  -w &lt;duration&gt;    Duration of wait seconds (e.g., 1s, 500ms, 2m) (default 1s)</span></span></code></pre></div><p>このオプションの並びに注目して頂きたいのですが、 <code>-f</code> オプションが一番上に来ています。
通常、 <code>flag</code> パッケージを使うと、オプションは英単語の昇順に表示されるため、必須オプションが上に来るとは限りません。
そうなると、Usageを見たときに必須オプションがどれなのかぱっと見分かりづらいです。
Custom Usage では、必須オプションに特定のマークを付与し、そのマークを元にソートを行うことで、必須オプションが上に来るようにしています。
これにより、Usageを見たときに必須オプションが強調されて一目で分かるようになります。</p><h2 id=custom-usage-のスニペットを紹介 style=font-family:var(--font-serif) class="leading-[1.2] tracking-[-0.02em] text-text-primary mt-[var(--space-md)] mb-[var(--space-md)] scroll-mt-[calc(var(--space-md)*2*1.2)] transition-colors font-medium text-[1.5rem]">Custom Usage のスニペットを紹介</h2><p>では、早速これらを実現するためのコードスニペットを紹介します！
flagパッケージを使ったコマンドラインツールに、以下のコードを追加してください。</p><div class="highlight my-[var(--space-md)]"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4 class="p-[var(--space-sm)] pt-[calc(var(--space-sm)*1.1)] md:p-[var(--space-md)] rounded-[4px] overflow-x-auto text-[0.75rem] md:text-[var(--text-sm)] leading-[1.6]"><code class="language-go bg-transparent p-0 text-inherit whitespace-pre inline-block [-webkit-text-size-adjust:none]" data-lang=go><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 必須オプションがあればこれを使ってマークする（この印を使ってUsage出力時に必須オプションが上に来るようにソートする処理が入ってます）</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Req</span> = <span style=color:#e6db74>&#34;(required) &#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>commandDescription</span>    = <span style=color:#e6db74>&#34;A sample command demonstrating simple template usage in Go CLI applications.&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 以下に他のオプションを定義していく...</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// optionFilePath = flag.String(&#34;f&#34;, &#34;&#34;, Req+&#34;File path&#34;)</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// optionUrl = flag.String(&#34;u&#34;, &#34;https://httpbin.org/get&#34;, &#34;URL&#34;)</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//...</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>init</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Usage</span> = <span style=color:#a6e22e>customUsage</span>(<span style=color:#a6e22e>commandDescription</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>customUsage</span>(<span style=color:#a6e22e>description</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>optionFieldWidth</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;16&#34;</span> <span style=color:#75715e>// Recommended width = general: 16, bool only: 5</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>b</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Buffer</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>func</span>() { <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>CommandLine</span>.<span style=color:#a6e22e>SetOutput</span>(<span style=color:#a6e22e>b</span>); <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>PrintDefaults</span>(); <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>CommandLine</span>.<span style=color:#a6e22e>SetOutput</span>(<span style=color:#66d9ef>nil</span>) }()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>re</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>regexp</span>.<span style=color:#a6e22e>MustCompile</span>(<span style=color:#e6db74>`(?m)^ +(-\S+)(?: (\S+))?\n*(\s+)(.*)\n`</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>usages</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Split</span>(<span style=color:#a6e22e>re</span>.<span style=color:#a6e22e>ReplaceAllStringFunc</span>(<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>String</span>(), <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>m</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>valueType</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ReplaceAll</span>(<span style=color:#e6db74>&#34;&lt;&#34;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>TrimSpace</span>(<span style=color:#a6e22e>re</span>.<span style=color:#a6e22e>FindStringSubmatch</span>(<span style=color:#a6e22e>m</span>)[<span style=color:#ae81ff>2</span>])<span style=color:#f92672>+</span><span style=color:#e6db74>&#34;&gt;&#34;</span>, <span style=color:#e6db74>&#34;&lt;&gt;&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;  %-&#34;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>optionFieldWidth</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#34;s %s\n&#34;</span>, <span style=color:#a6e22e>re</span>.<span style=color:#a6e22e>FindStringSubmatch</span>(<span style=color:#a6e22e>m</span>)[<span style=color:#ae81ff>1</span>]<span style=color:#f92672>+</span><span style=color:#e6db74>&#34; &#34;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>valueType</span>, <span style=color:#a6e22e>re</span>.<span style=color:#a6e22e>FindStringSubmatch</span>(<span style=color:#a6e22e>m</span>)[<span style=color:#ae81ff>4</span>])
</span></span><span style=display:flex><span>		}), <span style=color:#e6db74>&#34;\n&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sort</span>.<span style=color:#a6e22e>SliceStable</span>(<span style=color:#a6e22e>usages</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>j</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>bool</span> { <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Contains</span>(<span style=color:#a6e22e>usages</span>[<span style=color:#a6e22e>i</span>], <span style=color:#a6e22e>Req</span>) <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Contains</span>(<span style=color:#a6e22e>usages</span>[<span style=color:#a6e22e>j</span>], <span style=color:#a6e22e>Req</span>) })
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprintf</span>(<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>CommandLine</span>.<span style=color:#a6e22e>Output</span>(), <span style=color:#e6db74>&#34;Usage: %s [OPTIONS]\n\n&#34;</span>, <span style=color:#66d9ef>func</span>() <span style=color:#66d9ef>string</span> { <span style=color:#a6e22e>e</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Executable</span>(); <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Base</span>(<span style=color:#a6e22e>e</span>) }())
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprintf</span>(<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>CommandLine</span>.<span style=color:#a6e22e>Output</span>(), <span style=color:#e6db74>&#34;Description:\n  %s\n\n&#34;</span>, <span style=color:#a6e22e>description</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprintf</span>(<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>CommandLine</span>.<span style=color:#a6e22e>Output</span>(), <span style=color:#e6db74>&#34;Options:\n%s&#34;</span>, <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>usages</span>, <span style=color:#e6db74>&#34;\n&#34;</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// コマンドのメイン処理</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p><code>customUsage</code> は結構ごちゃごちゃしてますが、やってることを簡単に説明すると、 flag パッケージの Usage 出力を変数に入れてしまい、正規表現で必要な情報を取り出してから整形してます。
このとき、必須オプションには <code>Req</code> 定数を付与し、そのマークを元にソートを行うことで必須オプションが上に来るようにしています。
あとは、 <code>os.Executable()</code> を使って実行バイナリ名を取得し、 Usage の最初の行に表示しています。</p><h4 id=customusageで正規表現でusageをパースしている理由 style=font-family:var(--font-serif) class="leading-[1.2] tracking-[-0.02em] text-text-primary mt-[var(--space-md)] mb-[var(--space-md)] scroll-mt-[calc(var(--space-md)*2*1.2)] transition-colors font-medium text-base">customUsageで正規表現でUsageをパースしている理由</h4><p>flag パッケージに詳しい方なら</p><blockquote class="my-[var(--space-md)] pl-[var(--space-md)] border-l-[3px] border-accent italic font-sans text-base whitespace-normal [overflow-wrap:anywhere] [word-wrap:break-word] [&_p]:text-text-tertiary [&_a]:text-text-secondary"><p>flag パッケージの <code>flag.VisitAll</code> で登録されているフラグをすべて取得できるから、わざわざ正規表現で Usage をパースしなくてもいいのでは？</p></blockquote><p>と思うかもしれません。確かに <code>flag.VisitAll</code> を使えば登録されているフラグをすべて取得できます。
ただ、 <code>flag.VisitAll</code> を使う場合一点大きな問題がありました。それは「デフォルト値がわからない」という点です。
<code>flag</code> パッケージにはフラグのデフォルト値を取得するための関数が用意されておらず、 <code>flag.VisitAll</code> で取得できるのは</p><ul><li>フラグ名</li><li>設定されている値（デフォルトかどうかのフラグなし）</li><li>説明文</li></ul><p>の3つだけです。
このため、 <code>flag.VisitAll</code> を使って Usage を生成しようとすると、各フラグのデフォルト値が表示できなくなってしまいます。
flag パッケージはどうやってデフォルト値を判定しているのかというと&mldr;</p><blockquote class="my-[var(--space-md)] pl-[var(--space-md)] border-l-[3px] border-accent italic font-sans text-base whitespace-normal [overflow-wrap:anywhere] [word-wrap:break-word] [&_p]:text-text-tertiary [&_a]:text-text-secondary"><p>flag.go - Go<br><a href="https://cs.opensource.google/go/go/+/master:src/flag/flag.go;l=536-561?q=flag&amp;ss=go%2Fgo" class="text-accent no-underline border-b border-accent hover:text-text-primary hover:border-transparent relative transition-[border-color,color]">https://cs.opensource.google/go/go/+/master:src/flag/flag.go;l=536-561?q=flag&ss=go%2Fgo</a><br>─<br>isZeroValue determines whether the string represents the zero</p></blockquote><p>パッケージ内のprivate関数で判定する処理を実装しているんですよね。
ということで、これをそのまま丸々コピペするわけにはいかず、flag側が判定してくれたデフォルト値を Usage 出力からパースして再利用してる、という経緯でした。</p><h3 id=必須オプションのチェックについて style=font-family:var(--font-serif) class="leading-[1.2] tracking-[-0.02em] text-text-primary mt-[var(--space-md)] mb-[var(--space-md)] scroll-mt-[calc(var(--space-md)*2*1.2)] transition-colors font-medium text-[1.125rem]">必須オプションのチェックについて</h3><p>flag パッケージには必須オプションを指定する機能がないため、必須オプションのチェックは自分で実装する必要があります。
例えば、以下のように <code>flag.Parse()</code> の後に必須オプションが設定されているかどうかをチェックするコードを追加します。</p><div class="highlight my-[var(--space-md)]"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4 class="p-[var(--space-sm)] pt-[calc(var(--space-sm)*1.1)] md:p-[var(--space-md)] rounded-[4px] overflow-x-auto text-[0.75rem] md:text-[var(--text-sm)] leading-[1.6]"><code class="language-go bg-transparent p-0 text-inherit whitespace-pre inline-block [-webkit-text-size-adjust:none]" data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Parse</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>optionFilePath</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;\n[ERROR] Missing required option\n\n&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Usage</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Exit</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h2 id=スニペットの説明 style=font-family:var(--font-serif) class="leading-[1.2] tracking-[-0.02em] text-text-primary mt-[var(--space-md)] mb-[var(--space-md)] scroll-mt-[calc(var(--space-md)*2*1.2)] transition-colors font-medium text-[1.5rem]">スニペットの説明</h2><p>上記のスニペットでは、以下のポイントに注意してください。</p><ul><li><code>Req</code> 定数は、必須オプションを示すためのマークです。flagを定義する際の説明文の先頭にくっつけてください。<ul><li><code>Req</code> 定数の中身の文字列自体は好みに応じて変更してください。</li></ul></li><li><code>commandDescription</code> 変数には、コマンドの説明文を設定します。</li><li><code>init</code> 関数で <code>flag.Usage</code> に <code>customUsage</code> を設定しています。<ul><li>init関数はプログラムの実行前に自動的に呼び出されるため、ここで Usage を設定することで、プログラム全体でカスタム Usage が使用されます。</li></ul></li><li>もし Usage を表示した際にフラグと説明文の間のスペースが狭いと感じた場合は、 <code>optionFieldWidth</code> 変数の値を調整してください。デフォルトは16に設定しています。</li></ul><h2 id=ヘルプ表示について style=font-family:var(--font-serif) class="leading-[1.2] tracking-[-0.02em] text-text-primary mt-[var(--space-md)] mb-[var(--space-md)] scroll-mt-[calc(var(--space-md)*2*1.2)] transition-colors font-medium text-[1.5rem]">ヘルプ表示について</h2><p>以前は <code>-h</code> や <code>--help</code> オプションを自分で実装してヘルプ表示を行っていたんですが、ある時 flag パッケージはデフォルトで -h オプションをサポートしていることに気づきました。</p><blockquote class="my-[var(--space-md)] pl-[var(--space-md)] border-l-[3px] border-accent italic font-sans text-base whitespace-normal [overflow-wrap:anywhere] [word-wrap:break-word] [&_p]:text-text-tertiary [&_a]:text-text-secondary"><p>flag.go - Go<br><a href="https://cs.opensource.google/go/go/+/master:src/flag/flag.go;l=1109-1116?q=flag&amp;ss=go%2Fgo" class="text-accent no-underline border-b border-accent hover:text-text-primary hover:border-transparent relative transition-[border-color,color]">https://cs.opensource.google/go/go/+/master:src/flag/flag.go;l=1109-1116?q=flag&ss=go%2Fgo</a><br>─<br>if name == &ldquo;help&rdquo; || name == &ldquo;h&rdquo; { // special case for nice help message.</p></blockquote><p>そのため、Custom Usage のスニペットでは特に <code>-h</code> や <code>--help</code> オプションを実装していませんが、問題なくヘルプ表示は動作します。</p><h2 id=custom-usage-を使った完全な-maingo-のテンプレート style=font-family:var(--font-serif) class="leading-[1.2] tracking-[-0.02em] text-text-primary mt-[var(--space-md)] mb-[var(--space-md)] scroll-mt-[calc(var(--space-md)*2*1.2)] transition-colors font-medium text-[1.5rem]">Custom Usage を使った完全な main.go のテンプレート</h2><p>Custom Usage のスニペットを使った、完全な <code>main.go</code> のテンプレートも載せておきます。
新しくツールを作るときよかったら参考にしてもらえればと思います。</p><details><summary>main.go のテンプレート</summary><div class="highlight my-[var(--space-md)]"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4 class="p-[var(--space-sm)] pt-[calc(var(--space-sm)*1.1)] md:p-[var(--space-md)] rounded-[4px] overflow-x-auto text-[0.75rem] md:text-[var(--text-sm)] leading-[1.6]"><code class="language-go bg-transparent p-0 text-inherit whitespace-pre inline-block [-webkit-text-size-adjust:none]" data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;bytes&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;flag&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;path/filepath&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;regexp&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;sort&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;strings&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Req</span> = <span style=color:#e6db74>&#34;(required) &#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Command options (the -h and --help flags are provided by default in the flag package)</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>commandDescription</span>    = <span style=color:#e6db74>&#34;A sample command demonstrating simple template usage in Go CLI applications.&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>optionFilePath</span>        = <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;f&#34;</span> <span style=color:#75715e>/*   */</span>, <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#75715e>/*                         */</span>, <span style=color:#a6e22e>Req</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#34;File path&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>optionUrl</span>             = <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;u&#34;</span> <span style=color:#75715e>/*   */</span>, <span style=color:#e6db74>&#34;https://httpbin.org/get&#34;</span> <span style=color:#75715e>/*  */</span>, <span style=color:#e6db74>&#34;URL&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>optionLineIndex</span>       = <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Int</span>(<span style=color:#e6db74>&#34;l&#34;</span> <span style=color:#75715e>/*      */</span>, <span style=color:#ae81ff>10</span> <span style=color:#75715e>/*                         */</span>, <span style=color:#e6db74>&#34;Index of line&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>optionDurationWaitSec</span> = <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#e6db74>&#34;w&#34;</span> <span style=color:#75715e>/* */</span>, <span style=color:#ae81ff>1</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> <span style=color:#75715e>/*              */</span>, <span style=color:#e6db74>&#34;Duration of wait seconds (e.g., 3s, 500ms, 2m)&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>optionDebug</span>           = <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Bool</span>(<span style=color:#e6db74>&#34;d&#34;</span> <span style=color:#75715e>/*     */</span>, <span style=color:#66d9ef>false</span> <span style=color:#75715e>/*                      */</span>, <span style=color:#e6db74>&#34;Debug mode&#34;</span>)
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>init</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Usage</span> = <span style=color:#a6e22e>customUsage</span>(<span style=color:#a6e22e>commandDescription</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Parse</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 必須オプションチェック</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>optionFilePath</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;\n[ERROR] Missing required option: -f (file path)\n\n&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Usage</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Exit</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// オプションの値一覧を出力する</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;[ Command options ]\n&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>VisitAll</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>a</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Flag</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;  -%-30s %s\n&#34;</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%s %v&#34;</span>, <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Value</span>), <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Trim</span>(<span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Usage</span>, <span style=color:#e6db74>&#34;\n&#34;</span>))
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;\n\n&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//================= Custom usage function =================//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>customUsage</span>(<span style=color:#a6e22e>description</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>optionFieldWidth</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;16&#34;</span> <span style=color:#75715e>// Recommended width = general: 16, bool only: 5</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>b</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Buffer</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>func</span>() { <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>CommandLine</span>.<span style=color:#a6e22e>SetOutput</span>(<span style=color:#a6e22e>b</span>); <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>PrintDefaults</span>(); <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>CommandLine</span>.<span style=color:#a6e22e>SetOutput</span>(<span style=color:#66d9ef>nil</span>) }()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>re</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>regexp</span>.<span style=color:#a6e22e>MustCompile</span>(<span style=color:#e6db74>`(?m)^ +(-\S+)(?: (\S+))?\n*(\s+)(.*)\n`</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>usages</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Split</span>(<span style=color:#a6e22e>re</span>.<span style=color:#a6e22e>ReplaceAllStringFunc</span>(<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>String</span>(), <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>m</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>valueType</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ReplaceAll</span>(<span style=color:#e6db74>&#34;&lt;&#34;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>TrimSpace</span>(<span style=color:#a6e22e>re</span>.<span style=color:#a6e22e>FindStringSubmatch</span>(<span style=color:#a6e22e>m</span>)[<span style=color:#ae81ff>2</span>])<span style=color:#f92672>+</span><span style=color:#e6db74>&#34;&gt;&#34;</span>, <span style=color:#e6db74>&#34;&lt;&gt;&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;  %-&#34;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>optionFieldWidth</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#34;s %s\n&#34;</span>, <span style=color:#a6e22e>re</span>.<span style=color:#a6e22e>FindStringSubmatch</span>(<span style=color:#a6e22e>m</span>)[<span style=color:#ae81ff>1</span>]<span style=color:#f92672>+</span><span style=color:#e6db74>&#34; &#34;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>valueType</span>, <span style=color:#a6e22e>re</span>.<span style=color:#a6e22e>FindStringSubmatch</span>(<span style=color:#a6e22e>m</span>)[<span style=color:#ae81ff>4</span>])
</span></span><span style=display:flex><span>		}), <span style=color:#e6db74>&#34;\n&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sort</span>.<span style=color:#a6e22e>SliceStable</span>(<span style=color:#a6e22e>usages</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>j</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>bool</span> { <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Contains</span>(<span style=color:#a6e22e>usages</span>[<span style=color:#a6e22e>i</span>], <span style=color:#a6e22e>Req</span>) <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Contains</span>(<span style=color:#a6e22e>usages</span>[<span style=color:#a6e22e>j</span>], <span style=color:#a6e22e>Req</span>) })
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprintf</span>(<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>CommandLine</span>.<span style=color:#a6e22e>Output</span>(), <span style=color:#e6db74>&#34;Usage: %s [OPTIONS]\n\n&#34;</span>, <span style=color:#66d9ef>func</span>() <span style=color:#66d9ef>string</span> { <span style=color:#a6e22e>e</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Executable</span>(); <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Base</span>(<span style=color:#a6e22e>e</span>) }())
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprintf</span>(<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>CommandLine</span>.<span style=color:#a6e22e>Output</span>(), <span style=color:#e6db74>&#34;Description:\n  %s\n\n&#34;</span>, <span style=color:#a6e22e>description</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprintf</span>(<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>CommandLine</span>.<span style=color:#a6e22e>Output</span>(), <span style=color:#e6db74>&#34;Options:\n%s&#34;</span>, <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>usages</span>, <span style=color:#e6db74>&#34;\n&#34;</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}</span></span></code></pre></div></details><h2 id=まとめ style=font-family:var(--font-serif) class="leading-[1.2] tracking-[-0.02em] text-text-primary mt-[var(--space-md)] mb-[var(--space-md)] scroll-mt-[calc(var(--space-md)*2*1.2)] transition-colors font-medium text-[1.5rem]">まとめ</h2><p>Go 標準の flag パッケージを使ったコマンドラインアプリケーションで、 Usage を綺麗に整形して見やすくする方法について紹介しました。
Custom Usage を使うことで、外部ライブラリを使わずに見やすい Usage を実現できます。
ぜひ試してみてください！</p></div></article></main><footer class="w-full p-6 border-t border-border bg-surface"><div class="max-w-layout mx-auto flex justify-between items-center text-sm text-text-tertiary"><p>&copy; 2026 xshoji's blog. Crafted in Tokyo. All rights reserved.</p><nav class="social-links flex gap-6"><a href=https://github.com/xshoji target=_blank rel=noopener class="text-text-tertiary font-medium transition duration-150 hover:text-accent border-none">GitHub</a>
<a href=https://x.com/xshoji2020 target=_blank rel=noopener class="text-text-tertiary font-medium transition duration-150 hover:text-accent border-none">X</a>
<a href=/index.xml class="text-text-tertiary font-medium transition duration-150 hover:text-accent border-none">RSS</a></nav></div></footer></body></html>